name: ğŸš€Flutter CI

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'lib/**'
      - 'test/**'
      - 'i18n/**'
      - 'pubspec.yaml'
    # Always enable auto_format on push (handled in job logic)
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to test (leave empty for current)'
        required: false
        default: ''
      auto_format:
        description: 'Auto-format code if needed'
        required: false
        default: true
        type: boolean

jobs:
  analyze:
    name: ğŸ“Š Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event_name == 'pull_request' && format('refs/heads/{0}', github.head_ref)
            || (github.event.inputs.target_branch != '' && format('refs/heads/{0}', github.event.inputs.target_branch)
            || github.ref) }}

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”’ Assert minimum Dart SDK floor
        run: |
          DART_VERSION=$(dart --version 2>&1 | grep -oP '\d+\.\d+\.\d+' | head -1)
          REQUIRED="3.8.1"
          if [ "$(printf '%s\n' "$REQUIRED" "$DART_VERSION" | sort -V | head -1)" != "$REQUIRED" ]; then
            echo "âŒ Dart SDK $DART_VERSION is below required minimum $REQUIRED"
            exit 1
          fi
          echo "âœ… Dart SDK $DART_VERSION >= $REQUIRED"

      - name: ğŸ”¨ Regenerate mocks (build_runner)
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: ğŸ” Assert no diff after build_runner
        run: |
          echo "ğŸ¨ Checking Dart code formatting..."
          # Enable auto_format by default on push, or respect workflow_dispatch inputs
          AUTO_FORMAT="${{ github.event.inputs.auto_format }}"
          if [ "${{ github.event_name }}" = "push" ]; then
            AUTO_FORMAT="true"
          fi

          if ! dart format --set-exit-if-changed . 2>/dev/null; then
            echo "ğŸ“ Formatting issues detected!"
            if [ "$AUTO_FORMAT" = "true" ]; then
              echo "ğŸ”§ Auto-formatting enabled. Applying fixes..."
              dart format .
              git config --local user.email "action@github.com"
              git config --local user.name "GitHub Action [bot]"

              if [ "${{ github.event_name }}" = "pull_request" ]; then
                BRANCH="${{ github.head_ref }}"
              elif [ -n "${{ github.event.inputs.target_branch }}" ]; then
                BRANCH="${{ github.event.inputs.target_branch }}"
              else
                BRANCH="${{ github.ref_name }}"
              fi

              if ! git diff --quiet; then
                git add .
                git commit -m "ğŸ¨ Auto-format code with dart format [skip ci]"
                git push origin "$BRANCH"
              fi
            else
              echo "âŒ Auto-formatting is disabled. Please format manually:"
              dart format --show-all .
              exit 1
            fi
          else
            echo "âœ… All files are already properly formatted!"
          fi

      - name: ğŸ§¹ Remove unused imports (dart fix)
        run: |
          echo "ğŸ§¹ Eliminando imports no usados y aplicando fixes automÃ¡ticos..."
          dart fix --apply
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action [bot]"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH="${{ github.head_ref }}"
          elif [ -n "${{ github.event.inputs.target_branch }}" ]; then
            BRANCH="${{ github.event.inputs.target_branch }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi

          if ! git diff --quiet; then
            git add .
            git commit -m "ğŸ§¹ Remove unused imports and auto-fix code [skip ci]"
            git push origin "$BRANCH"
          fi

      - name: ğŸ” Analyze code
        run: flutter analyze --fatal-infos

      - name: ğŸ“š Check Dartdoc
        run: dart doc --validate-links

      - name: ğŸ“‹ Check pub.dev score
        run: dart pub deps

  test:
    name: ğŸ§ª Testing
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”’ Assert minimum Dart SDK floor
        run: |
          DART_VERSION=$(dart --version 2>&1 | grep -oP '\d+\.\d+\.\d+' | head -1)
          REQUIRED="3.8.1"
          if [ "$(printf '%s\n' "$REQUIRED" "$DART_VERSION" | sort -V | head -1)" != "$REQUIRED" ]; then
            echo "âŒ Dart SDK $DART_VERSION is below required minimum $REQUIRED"
            exit 1
          fi
          echo "âœ… Dart SDK $DART_VERSION >= $REQUIRED"

      - name: ğŸ”¨ Regenerate mocks (build_runner)
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            **/pubspec.lock
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: ğŸ§ª Run unit tests (expanded)
        run: |
          flutter test --coverage --reporter=expanded | tee test_output.txt

      - name: ğŸ“‹ Upload test output
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: test_output.txt

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: coverage/lcov.info
          fail_ci_if_error: false

      - name: ğŸ“ˆ Generate coverage report
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov
          genhtml coverage/lcov.info -o coverage/html
          lcov --summary coverage/lcov.info

      - name: ğŸ“‹ Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      - name: Commit and push README update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action [bot]"
          git add README.md
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ“Š Update README stats [skip ci]"
            git push
          fi

  comment:
    name: ğŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: [ analyze, test ]
    if: github.event_name == 'pull_request' && always()
    steps:
      - name: ğŸ“¥ Download coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
        continue-on-error: true

      - name: ğŸ’¬ Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const analyzeStatus = '${{ needs.analyze.result }}';
            const testStatus = '${{ needs.test.result }}';
            const getStatusEmoji = (status) => {
              switch (status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'â¹ï¸';
                case 'skipped': return 'â­ï¸';
                default: return 'ğŸ”„';
              }
            };
            const autoFormatEnabled = '${{ github.event.inputs.auto_format }}' === 'true' || '${{ github.event_name }}' === 'push';
            const formatNote = autoFormatEnabled ? 'ğŸ¨ Auto-format: Enabled' : 'âš ï¸ Auto-format: Disabled';
            const comment = `## ğŸ‰ CI Results for PR #${{ github.event.number }}

            ${getStatusEmoji(analyzeStatus)} **Static Analysis**: ${analyzeStatus}
            ${getStatusEmoji(testStatus)} **Tests**: ${testStatus}

            ${formatNote}

            ### ${analyzeStatus === 'success' && testStatus === 'success' ? 'ğŸš€ Ready to merge!' : 'âš ï¸ Issues found - check the logs'}

            ${analyzeStatus === 'failure' && !autoFormatEnabled ? '\nğŸ’¡ **Tip**: Enable auto-format when running the workflow to automatically fix formatting issues!' : ''}

            ---
            *Generated by GitHub Actions*`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“¤ Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
